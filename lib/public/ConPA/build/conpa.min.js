(function(e){"use strict";function t(){r.empty()}function a(e,t,a){r.html(o({type:"alert-error",heading:t,message:a,close:!1}))}var s='<div class="alert alert-block <%= type %>"><% if (close) { %><a class="close" data-dismiss="alert" href="#">Ã—</a><% } %><h4 class="alert-heading"><%= heading %></h4><%= message %></div>',o=_.template(s),r=e("#message");e.subscribe("clear.message.conpa",t),e.subscribe("error.message.conpa",a)})(jQuery),function(e){"use strict";function t(){e.ajax({url:"/ConPA/getLastCreatedPortfolios",success:function(t){_.extend(t,e.conpa.helpers),m.html(f(t))}})}function a(t){e.ajax({url:t.url,success:function(a){t.node.html(h({keyName:t.keyName,idDesc:t.idDesc,rows:a.rows,helpers:e.conpa.helpers}))}})}function s(){a({node:y,url:"/ConPA/getBestPerformingPortfolios",keyName:"Perf",idDesc:"Best"})}function o(){a({node:b,url:"/ConPA/getWorstPerformingPortfolios",keyName:"Perf",idDesc:"Worst"})}function r(){a({node:g,url:"/ConPA/getLowProfileRiskPortfolios",keyName:"Risk",idDesc:"Low"})}function n(){a({node:v,url:"/ConPA/getHighProfileRiskPortfolios",keyName:"Risk",idDesc:"High"})}function i(){a({node:x,url:"/ConPA/getLowProfileReturnPortfolios",keyName:"Ret",idDesc:"Low"})}function c(){a({node:w,url:"/ConPA/getHighProfileReturnPortfolios",keyName:"Ret",idDesc:"High"})}function l(t){var a=e(t.target).parent().data("id");return a?(e("html, body").animate({scrollTop:0},"slow"),e.ajax({url:"/ConPA/getPortfolio",type:"POST",data:{id:a},success:function(t){var a,s={};t.error||(s.assets=[],_.each(t.assets,function(t){s.assets.push({id:e.conpa.utils.rfc4122v4(),symbol:t})}),a=new Date(t.ref),s.refdate=e.conpa.dates.isToday(a)?""+e.conpa.dates.yearToDate():""+new Date(t.ref),e.sync("conpa",s),e.publish("render.app.conpa"))}}),void 0):!1}function p(){t(),s(),o(),r(),n(),i(),c()}var u='<table class="table table-bordered table-condensed table-hover"><thead><tr><th>To Date</th><th>Reference Date</th><th>Last Created</th><th>Perf</th><th>Risk</th><th>Ret</th></tr></thead><tbody><% _.each(rows, function (row, key, list) { %><tr data-id=<%= row.id %>><td><%= row.key %></td><td><%= row.value.ref %></td><td title=<%= row.id %>><%= hyphenFormatter(row.id) %></td><td><%= percentageFormatter(row.value.perf) %></td><td><%= percentageFormatter(row.value.risk) %></td><td><%= percentageFormatter(row.value.ret) %></td></tr><% }) %></tbody></table>',d='<table class="table table-bordered table-condensed table-hover"><thead><tr><th><%= keyName %></th><th>To Date</th><th><%= idDesc %></th></tr></thead><tbody><% _.each(rows, function (row, key, list) { %><tr data-id=<%= row.id %>><td><%= helpers.percentageFormatter(row.key) %></td><td><%= row.value.created_at %></td><td title=<%= row.id %>><%= helpers.hyphenFormatter(row.id) %></td></tr><% }) %></tbody></table>',f=_.template(u),h=_.template(d),m=e("#latest-portfolios-list"),y=e("#best-performing-portfolios-list"),b=e("#worst-performing-portfolios-list"),g=e("#lowprofile-risk-portfolios-list"),v=e("#highprofile-risk-portfolios-list"),x=e("#lowprofile-return-portfolios-list"),w=e("#highprofile-return-portfolios-list");e("body").on("click",".table tbody tr",l),e.subscribe("render.dashboard.conpa",p)}(jQuery),function(e){"use strict";function t(t,a,s,o,r,n,i,c,l){e.ajax({url:"/ConPA/putPortfolioOnCRM",type:"POST",data:{symbols:a,weights:s,ref:o,ret:r,risk:n,perf:i,highs:c,lows:l},success:function(){e.publish("render.dashboard.conpa")}})}e.subscribe("crm.portfolio.conpa",t)}(jQuery),function(e){"use strict";function t(t,a,s){t.sparkline(s,{type:"pie",height:"150",offset:90,tooltipFormatter:function(t,o,r){var n;return e.grep(s,function(e,t){e===r.value&&(n=t)}),a[n]+" "+e.conpa.helpers.percentageFormatter(r.value)}})}function a(t,a){t.sparkline(a,{type:"bar",height:"150",barWidth:2,tooltipFormatter:function(t,a,s){return e.conpa.helpers.percentageFormatter(s[0].value)}})}function s(s,o){var r=[],u=[];s=e.map(s,function(e,t){return r[t]=0,u[t]=-1,e.symbol}),3>s.length||(o=o||""+new Date,e.ajax({url:"/ConPA/getOptimalPortfolio",type:"POST",data:{prods:s,referenceDate:o,targetReturn:void 0,lows:r,highs:u},success:function(d){return d.message?(e.publish("error.message.conpa",["Optimization error",d.message]),void 0):(e.publish("crm.portfolio.conpa",[s,d.optim.solution,o,d.optim.pm,d.optim.ps,d.perf,u,r]),d.perf.length?(i.html(e.conpa.dates.ymdDate(o)+" Weights"),t(c,s,d.optim.solution),l.html(e.conpa.dates.ymdDate(o)+" Performance"),a(p,d.perf)):t(n,s,d.optim.solution),void 0)}}))}function o(){n.empty(),c.empty(),p.empty()}function r(e,t,a){s(t,a)}var n=e("#basket-pie-chart"),i=e("#basket-pie-refdate-label"),c=e("#basket-pie-ytd-chart"),l=e("#basket-performance-refdate-label"),p=e("#basket-performance-ytd-chart");e.subscribe("clear.portfolio.conpa",o),e.subscribe("optimize.portfolio.conpa",r)}(jQuery),function(e){"use strict";function t(t){e.ajax({url:"/ConPA/getKeyStatistics",type:"POST",data:{symbol:t},success:function(e){var a,s,c;e.length&&(a=e.length/2,s=e,c=s.splice(0,a),r.html("Asset Stats for "+t),n.html(o({fields:c})),i.html(o({fields:s})))}})}function a(e,a){t(a)}var s='<dl class="dl-horizontal"><% _.each(fields, function (field) { %><dt title="<%= field.inputParams.label %>"><%= field.inputParams.label %></dt><dd><%= field.inputParams.value %></dd><% }) %></dl>',o=_.template(s),r=e("#asset-stats-name"),n=e("#asset-stats-list1"),i=e("#asset-stats-list2");e.subscribe("stats.asset.conpa",a)}(jQuery),function(e){"use strict";function t(){r.html(o({assets:e.sync("conpa").assets}))}function a(a){var s=e(a.target).closest("li").data("id"),o=e.sync("conpa");e.each(o.assets,function(a,r){return r.id===s?(o.assets.splice(a,1),3>o.assets.length&&(o.refdate=""+e.conpa.dates.yearToDate()),e.sync("conpa",o),t(),e.publish("render.app.conpa"),!1):void 0})}var s='<% _.each(assets, function (asset, key, list) { %><li data-id="<%= asset.id %>"><div class="well"><div><%= asset.symbol %></div><div class="destroy"></div></div></li><% }) %>',o=_.template(s),r=e("#asset-list");r.on("click",".destroy",a),e.subscribe("render.assetlist.conpa",t)}(jQuery);var YAHOO={};YAHOO.Finance={},YAHOO.Finance.SymbolSuggest={},function(e){"use strict";var t={};e("input").typeahead({items:10,source:function(e,a){jQuery.ajax({type:"GET",dataType:"jsonp",jsonp:"callback",jsonpCallback:"YAHOO.Finance.SymbolSuggest.ssCallback",data:{query:e},cache:!0,url:"http://autoc.finance.yahoo.com/autoc"}),YAHOO.Finance.SymbolSuggest.ssCallback=function(e){var s;s=jQuery.map(e.ResultSet.Result,function(e){var a={symbol:e.symbol,name:e.name,type:e.type,exchDisp:e.exchDisp},s=a.symbol+" "+a.name+" ("+a.type+" - "+a.exchDisp+")";return t[s]=a,s}),a(s)}},updater:function(e){return t[e].symbol}})}(jQuery),function(e){"use strict";e.conpa={utils:{rfc4122v4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),a="x"===e?t:8|3&t;return a.toString(16)})}},helpers:{percentageFormatter:function(e){return(100*e).toFixed(2)+"%"},hyphenFormatter:function(e){return e.substr(0,5)+"..."+e.substr(e.length-5,5)}},dates:{today:function(){return new Date},isToday:function(t){var a=e.conpa.dates.today(),s=a.getDate(),o=a.getMonth(),r=a.getFullYear(),n=t.getDate(),i=t.getMonth(),c=t.getFullYear();return s===n&&o===i&&r===c},yearToDate:function(){return new Date(e.conpa.dates.today()-31536e6)},ymdDate:function(e){var t=new Date(e),a=t.getDate(),s=t.getMonth()+1,o=t.getFullYear();return o+"/"+(10>s?"0"+s:s)+"/"+(10>a?"0"+a:a)}}}}(jQuery),function(e){"use strict";var t={init:function(){var t=e.sync("conpa");t.assets=t.assets||[],t.refdate=t.refdate||""+e.conpa.dates.yearToDate(),e.sync("conpa",{assets:t.assets,refdate:t.refdate}),e("#new-asset").on("change",this.create),e.publish("render.dashboard.conpa"),e.publish("render.app.conpa")},create:function(t){var a=e.sync("conpa"),s=e(t.target),o=e.trim(s.val());s.val(""),t.hasOwnProperty("originalEvent")||(a.assets.push({id:e.conpa.utils.rfc4122v4(),symbol:o}),e.sync("conpa",a),e.publish("render.app.conpa"))},render:function(){var t=e.sync("conpa"),a=_.last(t.assets);e.publish("clear.portfolio.conpa"),e.publish("clear.message.conpa"),e.publish("render.assetlist.conpa"),t.assets.length&&e.publish("stats.asset.conpa",[a.symbol]),e.publish("optimize.portfolio.conpa",[t.assets,""+e.conpa.dates.today()]),e.publish("optimize.portfolio.conpa",[t.assets,t.refdate])}};e.subscribe("render.app.conpa",t.render),t.init()}(jQuery);