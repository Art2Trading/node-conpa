(function(e){"use strict";function i(){r.empty()}function s(e,t,i){r.html(n({type:"alert-error",heading:t,message:i,close:!1}))}var t='<div class="alert alert-block <%= type %>"><% if (close) { %><a class="close" data-dismiss="alert" href="#">Ã—</a><% } %><h4 class="alert-heading"><%= heading %></h4><%= message %></div>',n=_.template(t),r=e("#message");e.subscribe("clear.message.conpa",i),e.subscribe("error.message.conpa",s)})(jQuery),function(e){"use strict";function h(){e.ajax({url:"/ConPA/getLastCreatedPortfolios",success:function(t){_.extend(t,e.conpa.helpers),s.html(r(t))}})}function p(t){e.ajax({url:t.url,success:function(n){t.node.html(i({keyName:t.keyName,idDesc:t.idDesc,rows:n.rows,helpers:e.conpa.helpers}))}})}function d(){p({node:o,url:"/ConPA/getBestPerformingPortfolios",keyName:"Perf",idDesc:"Best"})}function v(){p({node:u,url:"/ConPA/getWorstPerformingPortfolios",keyName:"Perf",idDesc:"Worst"})}function m(){p({node:a,url:"/ConPA/getLowProfileRiskPortfolios",keyName:"Risk",idDesc:"Low"})}function g(){p({node:f,url:"/ConPA/getHighProfileRiskPortfolios",keyName:"Risk",idDesc:"High"})}function y(){p({node:l,url:"/ConPA/getLowProfileReturnPortfolios",keyName:"Ret",idDesc:"Low"})}function b(){p({node:c,url:"/ConPA/getHighProfileReturnPortfolios",keyName:"Ret",idDesc:"High"})}function w(t){var n=e(t.target).parent().data("id");if(!n)return!1;e("html, body").animate({scrollTop:0},"slow"),e.ajax({url:"/ConPA/getPortfolio",type:"POST",data:{id:n},success:function(t){var n={},r;if(t.error)return;n.assets=[],_.each(t.assets,function(t){n.assets.push({id:e.conpa.utils.rfc4122v4(),symbol:t})}),r=new Date(t.ref),e.conpa.dates.isToday(r)?n.refdate=e.conpa.dates.yearToDate().toString():n.refdate=(new Date(t.ref)).toString(),e.sync("conpa",n),e.publish("render.app.conpa")}})}function E(){h(),d(),v(),m(),g(),y(),b()}var t='<table class="table table-bordered table-condensed table-hover"><thead><tr><th>To Date</th><th>Reference Date</th><th>Last Created</th><th>Perf</th><th>Risk</th><th>Ret</th></tr></thead><tbody><% _.each(rows, function (row, key, list) { %><tr data-id=<%= row.id %>><td><%= row.key %></td><td><%= row.value.ref %></td><td title=<%= row.id %>><%= hyphenFormatter(row.id) %></td><td><%= percentageFormatter(row.value.perf) %></td><td><%= percentageFormatter(row.value.risk) %></td><td><%= percentageFormatter(row.value.ret) %></td></tr><% }) %></tbody></table>',n='<table class="table table-bordered table-condensed table-hover"><thead><tr><th><%= keyName %></th><th>To Date</th><th><%= idDesc %></th></tr></thead><tbody><% _.each(rows, function (row, key, list) { %><tr data-id=<%= row.id %>><td><%= helpers.percentageFormatter(row.key) %></td><td><%= row.value.created_at %></td><td title=<%= row.id %>><%= helpers.hyphenFormatter(row.id) %></td></tr><% }) %></tbody></table>',r=_.template(t),i=_.template(n),s=e("#latest-portfolios-list"),o=e("#best-performing-portfolios-list"),u=e("#worst-performing-portfolios-list"),a=e("#lowprofile-risk-portfolios-list"),f=e("#highprofile-risk-portfolios-list"),l=e("#lowprofile-return-portfolios-list"),c=e("#highprofile-return-portfolios-list");e("body").on("click",".table tbody tr",w),e.subscribe("render.dashboard.conpa",E)}(jQuery),function(e){"use strict";function t(t,n,r,i,s,o,u,a,f){e.ajax({url:"/ConPA/putPortfolioOnCRM",type:"POST",data:{symbols:n,weights:r,ref:i,ret:s,risk:o,perf:u,highs:a,lows:f},success:function(){e.publish("render.dashboard.conpa")}})}e.subscribe("crm.portfolio.conpa",t)}(jQuery),function(e){"use strict";function o(t,n,r){t.sparkline(r,{type:"pie",height:"150",offset:90,tooltipFormatter:function(t,i,s){var o;return e.grep(r,function(e,t){e===s.value&&(o=t)}),n[o]+" "+e.conpa.helpers.percentageFormatter(s.value)}})}function u(t,n){t.sparkline(n,{type:"bar",height:"150",barWidth:2,tooltipFormatter:function(t,n,r){return e.conpa.helpers.percentageFormatter(r[0].value)}})}function a(a,f){var l=[],c=[];a=e.map(a,function(e,t){return l[t]=0,c[t]=-1,e.symbol});if(a.length<3)return;f=f||(new Date).toString(),e.ajax({url:"/ConPA/getOptimalPortfolio",type:"POST",data:{prods:a,referenceDate:f,targetReturn:undefined,lows:l,highs:c},success:function(h){if(h.message){e.publish("error.message.conpa",["Optimization error",h.message]);return}e.publish("crm.portfolio.conpa",[a,h.optim.solution,f,h.optim.pm,h.optim.ps,h.perf,c,l]),h.perf.length?(n.html(e.conpa.dates.ymdDate(f)+" Weights"),o(r,a,h.optim.solution),i.html(e.conpa.dates.ymdDate(f)+" Performance"),u(s,h.perf)):o(t,a,h.optim.solution)}})}function f(){t.empty(),r.empty(),s.empty()}function l(e,t,n){a(t,n)}var t=e("#basket-pie-chart"),n=e("#basket-pie-refdate-label"),r=e("#basket-pie-ytd-chart"),i=e("#basket-performance-refdate-label"),s=e("#basket-performance-ytd-chart");e.subscribe("clear.portfolio.conpa",f),e.subscribe("optimize.portfolio.conpa",l)}(jQuery),function(e){"use strict";function o(t){e.ajax({url:"/ConPA/getKeyStatistics",type:"POST",data:{symbol:t},success:function(e){var o,u,a;if(!e.length)return;o=e.length/2,u=e,a=u.splice(0,o),r.html("Asset Stats for "+t),i.html(n({fields:a})),s.html(n({fields:u}))}})}function u(e,t){o(t)}var t='<dl class="dl-horizontal"><% _.each(fields, function (field) { %><dt title="<%= field.inputParams.label %>"><%= field.inputParams.label %></dt><dd><%= field.inputParams.value %></dd><% }) %></dl>',n=_.template(t),r=e("#asset-stats-name"),i=e("#asset-stats-list1"),s=e("#asset-stats-list2");e.subscribe("stats.asset.conpa",u)}(jQuery),function(e){"use strict";function i(){r.html(n({assets:e.sync("conpa").assets}))}function s(t){var n=e(t.target).closest("li").data("id"),r=e.sync("conpa");e.each(r.assets,function(t,s){if(s.id===n)return r.assets.splice(t,1),r.assets.length<3&&(r.refdate=e.conpa.dates.yearToDate().toString()),e.sync("conpa",r),i(),e.publish("render.app.conpa"),!1})}var t='<% _.each(assets, function (asset, key, list) { %><li data-id="<%= asset.id %>"><div class="well"><div><%= asset.symbol %></div><div class="destroy"></div></div></li><% }) %>',n=_.template(t),r=e("#asset-list");r.on("click",".destroy",s),e.subscribe("render.assetlist.conpa",i)}(jQuery);var YAHOO={};YAHOO.Finance={},YAHOO.Finance.SymbolSuggest={},function(e){"use strict";var t={};e("input").typeahead({items:10,source:function(e,n){jQuery.ajax({type:"GET",dataType:"jsonp",jsonp:"callback",jsonpCallback:"YAHOO.Finance.SymbolSuggest.ssCallback",data:{query:e},cache:!0,url:"http://autoc.finance.yahoo.com/autoc"}),YAHOO.Finance.SymbolSuggest.ssCallback=function(e){var r;r=jQuery.map(e.ResultSet.Result,function(e){var n={symbol:e.symbol,name:e.name,type:e.type,exchDisp:e.exchDisp},r=n.symbol+" "+n.name+" ("+n.type+" - "+n.exchDisp+")";return t[r]=n,r}),n(r)}},updater:function(e){return t[e].symbol}})}(jQuery),function(e){"use strict";e.conpa={utils:{rfc4122v4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)})}},helpers:{percentageFormatter:function(e){return(e*100).toFixed(2)+"%"},hyphenFormatter:function(e){return e.substr(0,5)+"..."+e.substr(e.length-5,5)}},dates:{today:function(){return new Date},isToday:function(t){var n=e.conpa.dates.today(),r=n.getDate(),i=n.getMonth(),s=n.getFullYear(),o=t.getDate(),u=t.getMonth(),a=t.getFullYear();return r===o&&i===u&&s===a},yearToDate:function(){return new Date(e.conpa.dates.today()-31536e6)},ymdDate:function(e){var t=new Date(e),n=t.getDate(),r=t.getMonth()+1,i=t.getFullYear();return i+"/"+(r<10?"0"+r:r)+"/"+(n<10?"0"+n:n)}}}}(jQuery),function(e){"use strict";var t={init:function(){var t=e.sync("conpa");t.assets=t.assets||[],t.refdate=t.refdate||e.conpa.dates.yearToDate().toString(),e.sync("conpa",{assets:t.assets,refdate:t.refdate}),e("#new-asset").on("change",this.create),e.publish("render.dashboard.conpa"),e.publish("render.app.conpa")},create:function(t){var n=e.sync("conpa"),r=e(t.target),i=e.trim(r.val());r.val("");if(t.hasOwnProperty("originalEvent"))return;n.assets.push({id:e.conpa.utils.rfc4122v4(),symbol:i}),e.sync("conpa",n),e.publish("render.app.conpa")},render:function(){var t=e.sync("conpa"),n=_.last(t.assets);e.publish("clear.portfolio.conpa"),e.publish("clear.message.conpa"),e.publish("render.assetlist.conpa"),t.assets.length&&e.publish("stats.asset.conpa",[n.symbol]),e.publish("optimize.portfolio.conpa",[t.assets,e.conpa.dates.today().toString()]),e.publish("optimize.portfolio.conpa",[t.assets,t.refdate])}};e.subscribe("render.app.conpa",t.render),t.init()}(jQuery);