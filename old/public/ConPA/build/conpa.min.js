!function(a,b){"use strict";function c(){g.empty()}function d(a,b,c){g.html(f({type:"alert-error",heading:b,message:c,close:!1}))}var e='<div class="alert alert-block <%= type %>"><% if (close) { %><a class="close" data-dismiss="alert" href="#">Ã—</a><% } %><h4 class="alert-heading"><%= heading %></h4><%= message %></div>',f=b.template(e),g=a("#message");a.subscribe("clear.message.conpa",c),a.subscribe("error.message.conpa",d)}(jQuery,window._),function(a,b){"use strict";function c(c,d){a.ajax({url:"/ConPA/getLastCreatedPortfolios",data:{limit:c},success:function(c){b.extend(c,{limit:d-1},a.conpa.helpers),q.html(o(c)),a.publish("render.latestptfschart.conpa",[c])}})}function d(b){a.ajax({url:b.url,success:function(c){b.node.html(p({keyName:b.keyName,idDesc:b.idDesc,rows:c.rows,helpers:a.conpa.helpers}))}})}function e(){d({node:r,url:"/ConPA/getBestPerformingPortfolios",keyName:"Perf",idDesc:"Best"})}function f(){d({node:s,url:"/ConPA/getWorstPerformingPortfolios",keyName:"Perf",idDesc:"Worst"})}function g(){d({node:t,url:"/ConPA/getLowProfileRiskPortfolios",keyName:"Risk",idDesc:"Low"})}function h(){d({node:u,url:"/ConPA/getHighProfileRiskPortfolios",keyName:"Risk",idDesc:"High"})}function i(){d({node:v,url:"/ConPA/getLowProfileReturnPortfolios",keyName:"Ret",idDesc:"Low"})}function j(){d({node:w,url:"/ConPA/getHighProfileReturnPortfolios",keyName:"Ret",idDesc:"High"})}function k(c){var d=a(c.target).parent().data("id");return d?(a("html, body").animate({scrollTop:0},"slow"),void a.ajax({url:"/ConPA/getPortfolio",type:"POST",data:{id:d},success:function(c){var d,e={};c.error||(e.assets=[],b.each(c.assets,function(b){e.assets.push({id:a.conpa.utils.rfc4122v4(),symbol:b})}),d=new Date(c.ref),a.conpa.dates.isToday(d)?e.refdate=a.conpa.dates.yearToDate().toString():e.refdate=new Date(c.ref).toString(),a.sync("conpa",e),a.publish("render.app.conpa"))}})):!1}function l(){c(100,12),e(),f(),g(),h(),i(),j()}var m='<table class="table table-bordered table-condensed table-hover"><thead><tr><th>To Date</th><th>Reference Date</th><th>Last Created</th><th>Perf</th><th>Risk</th><th>Ret</th></tr></thead><tbody><% _.each(rows, function (row, key, list) { %><% if (key > limit) { %><% return; %><% } %><tr data-id=<%= row.id %>><td><%= row.key %></td><td><%= row.value.ref %></td><td title=<%= row.id %>><%= hyphenFormatter(row.id) %></td><td><%= percentageFormatter(row.value.perf) %></td><td><%= percentageFormatter(row.value.risk) %></td><td><%= percentageFormatter(row.value.ret) %></td></tr><% }) %></tbody></table>',n='<table class="table table-bordered table-condensed table-hover"><thead><tr><th><%= keyName %></th><th>To Date</th><th><%= idDesc %></th></tr></thead><tbody><% _.each(rows, function (row, key, list) { %><tr data-id=<%= row.id %>><td><%= helpers.percentageFormatter(row.key) %></td><td><%= row.value.created_at %></td><td title=<%= row.id %>><%= helpers.hyphenFormatter(row.id) %></td></tr><% }) %></tbody></table>',o=b.template(m),p=b.template(n),q=a("#latest-portfolios-list"),r=a("#best-performing-portfolios-list"),s=a("#worst-performing-portfolios-list"),t=a("#lowprofile-risk-portfolios-list"),u=a("#highprofile-risk-portfolios-list"),v=a("#lowprofile-return-portfolios-list"),w=a("#highprofile-return-portfolios-list");a("body").on("click",".table tbody tr",k),a.subscribe("render.dashboard.conpa",l)}(jQuery,window._),function(a){"use strict";function b(b,c,d,e,f,g,h,i,j){a.ajax({url:"/ConPA/putPortfolioOnCRM",type:"POST",data:{symbols:c,weights:d,ref:e,ret:f,risk:g,perf:h,highs:i,lows:j},success:function(){a.publish("render.dashboard.conpa")}})}a.subscribe("crm.portfolio.conpa",b)}(jQuery),function(a){"use strict";function b(b,c){var d=[],e=[];b=a.map(b,function(a,b){return d[b]=0,e[b]=-1,a.symbol}),b.length<3||(c=c||(new Date).toString(),a.ajax({url:"/ConPA/getOptimalPortfolio",type:"POST",data:{prods:b,referenceDate:c,targetReturn:null,lows:d,highs:e},success:function(g){return g.message?void a.publish("error.message.conpa",["Optimization error",g.message]):(a.publish("crm.portfolio.conpa",[b,g.optim.solution,c,g.optim.pm,g.optim.ps,g.perf,e,d]),void(g.perf.length?(f.html(a.conpa.dates.ymdDate(c)+" Weights"),a.publish("render.piechart.conpa",["#basket-pie-ytd-chart",b,g.optim.solution]),h.html(a.conpa.dates.ymdDate(c)+" Performance"),a.publish("render.perfchart.conpa",["#basket-performance-ytd-chart",g.perf])):a.publish("render.piechart.conpa",["#basket-pie-chart",b,g.optim.solution])))}}))}function c(){e.empty(),g.empty(),i.empty()}function d(a,c,d){b(c,d)}var e=a("#basket-pie-chart"),f=a("#basket-pie-refdate-label"),g=a("#basket-pie-ytd-chart"),h=a("#basket-performance-refdate-label"),i=a("#basket-performance-ytd-chart");a.subscribe("clear.portfolio.conpa",c),a.subscribe("optimize.portfolio.conpa",d)}(jQuery),function(a,b){"use strict";b.load("visualization","1",{packages:["corechart"],callback:function(){function c(a){return 1*(100*a).toFixed(2)}function d(d,e){var f={backgroundColor:"transparent",title:"Graph based on the latest 100 portfolios",hAxis:{title:"Risk %"},vAxis:{title:"Return %"},legend:"none"},g=[],h=new google.visualization.DataTable,i=new b.visualization.ScatterChart(a("#efficient-frontier").get()[0]);h.addColumn("number","Risk"),h.addColumn("number","Return"),h.addColumn({type:"string",role:"tooltip"}),e.rows.forEach(function(a){var b=c(parseFloat(a.value.risk)),d=c(parseFloat(a.value.ret)),e=c(parseFloat(a.value.perf)),f="";a.value.assets.forEach(function(b,d){f+=b+": "+c(a.value.weights[d])+"%\n"}),g.push([b,d,"Risk: "+b+"%\nReturn: "+d+"%\nPerf.: "+(e?e+"%":"n.a.")+"\n"+f+a.value.ref])}),h.addRows(g),i.draw(h,f)}function e(c,d,e,f){var g={backgroundColor:"transparent",pieSliceText:"label",pieHole:.2,legend:"none"},h=[],i=new b.visualization.DataTable,j=new b.visualization.PieChart(a(d).get()[0]);e.forEach(function(a,b){h.push([a,f[b]])}),i.addColumn("string","Asset"),i.addColumn("number","Weight"),i.addRows(h),j.draw(i,g)}function f(d,e,f){var g={backgroundColor:"transparent",legend:"none"},h=[],i=new b.visualization.DataTable,j=new b.visualization.ColumnChart(a(e).get()[0]);f.forEach(function(a,b){h.push([b,a,"Perf: "+c(a)+"%"])}),i.addColumn("number","Week"),i.addColumn("number","Performance"),i.addColumn({type:"string",role:"tooltip"}),i.addRows(h),j.draw(i,g)}a.subscribe("render.latestptfschart.conpa",d),a.subscribe("render.piechart.conpa",e),a.subscribe("render.perfchart.conpa",f)}})}(jQuery,google),function(a,b){"use strict";function c(b){a.ajax({url:"/ConPA/getKeyStatistics",type:"POST",data:{symbol:b},success:function(a){var c,d,e;a.length&&(c=a.length/2,d=a,e=d.splice(0,c),g.html("Asset Stats for "+b),h.html(f({fields:e})),i.html(f({fields:d})))}})}function d(a,b){c(b)}var e='<dl class="dl-horizontal"><% _.each(fields, function (field) { %><dt title="<%= field.label %>"><%= field.label %></dt><dd><%= field.value %></dd><% }) %></dl>',f=b.template(e),g=a("#asset-stats-name"),h=a("#asset-stats-list1"),i=a("#asset-stats-list2");a.subscribe("stats.asset.conpa",d)}(jQuery,window._),function(a,b){"use strict";function c(){g.html(f({assets:a.sync("conpa").assets}))}function d(b){var d=a(b.target).closest("li").data("id"),e=a.sync("conpa");a.each(e.assets,function(b,f){return f.id===d?(e.assets.splice(b,1),e.assets.length<3&&(e.refdate=a.conpa.dates.yearToDate().toString()),a.sync("conpa",e),c(),a.publish("render.app.conpa"),!1):void 0})}var e='<% _.each(assets, function (asset, key, list) { %><li data-id="<%= asset.id %>"><div class="well"><div><%= asset.symbol %></div><div class="destroy"></div></div></li><% }) %>',f=b.template(e),g=a("#asset-list");g.on("click",".destroy",d),a.subscribe("render.assetlist.conpa",c)}(jQuery,window._);var YAHOO={};YAHOO.Finance={},YAHOO.Finance.SymbolSuggest={},function(a){"use strict";var b={};a("input").typeahead({items:10,source:function(a,c){jQuery.ajax({type:"GET",dataType:"jsonp",jsonp:"callback",jsonpCallback:"YAHOO.Finance.SymbolSuggest.ssCallback",data:{query:a},cache:!0,url:"http://autoc.finance.yahoo.com/autoc"}),YAHOO.Finance.SymbolSuggest.ssCallback=function(a){var d;d=jQuery.map(a.ResultSet.Result,function(a){var c={symbol:a.symbol,name:a.name,type:a.type,exchDisp:a.exchDisp},d=c.symbol+" "+c.name+" ("+c.type+" - "+c.exchDisp+")";return b[d]=c,d}),c(d)}},updater:function(a){return b[a].symbol}})}(jQuery),function(a){"use strict";a.conpa={utils:{rfc4122v4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})}},helpers:{percentageFormatter:function(a){return(100*a).toFixed(2)+"%"},hyphenFormatter:function(a){return a.substr(0,5)+"..."+a.substr(a.length-5,5)}},dates:{today:function(){return new Date},isToday:function(b){var c=a.conpa.dates.today(),d=c.getDate(),e=c.getMonth(),f=c.getFullYear(),g=b.getDate(),h=b.getMonth(),i=b.getFullYear();return d===g&&e===h&&f===i},yearToDate:function(){return new Date(a.conpa.dates.today()-31536e6)},ymdDate:function(a){var b=new Date(a),c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear();return e+"/"+(10>d?"0"+d:d)+"/"+(10>c?"0"+c:c)}}}}(jQuery),function(a){"use strict";var b={init:function(){var b=a.sync("conpa");b.assets=b.assets||[],b.refdate=b.refdate||a.conpa.dates.yearToDate().toString(),a.sync("conpa",{assets:b.assets,refdate:b.refdate}),a("#new-asset").on("change",this.create),a.publish("render.dashboard.conpa"),a.publish("render.app.conpa")},create:function(b){var c=a.sync("conpa"),d=a(b.target),e=a.trim(d.val());d.val(""),b.hasOwnProperty("originalEvent")||(c.assets.push({id:a.conpa.utils.rfc4122v4(),symbol:e}),a.sync("conpa",c),a.publish("render.app.conpa"))},render:function(){var b=a.sync("conpa"),c=_.last(b.assets);a.publish("clear.portfolio.conpa"),a.publish("clear.message.conpa"),a.publish("render.assetlist.conpa"),b.assets.length&&a.publish("stats.asset.conpa",[c.symbol]),a.publish("optimize.portfolio.conpa",[b.assets,a.conpa.dates.today().toString()]),a.publish("optimize.portfolio.conpa",[b.assets,b.refdate])}};a.subscribe("render.app.conpa",b.render),b.init()}(jQuery);